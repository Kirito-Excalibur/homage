<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GameManager Integration Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #2c3e50;
            color: #ecf0f1;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
        }
        .test-section {
            background-color: #34495e;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
        }
        .test-result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
        }
        .pass {
            background-color: #27ae60;
            color: white;
        }
        .fail {
            background-color: #e74c3c;
            color: white;
        }
        .info {
            background-color: #3498db;
            color: white;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #2980b9;
        }
        #game-container {
            width: 800px;
            height: 600px;
            margin: 20px auto;
            border: 2px solid #7f8c8d;
            border-radius: 8px;
        }
        .debug-panel {
            background-color: #1a1a1a;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            padding: 15px;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ðŸ§ª GameManager Integration Test</h1>
        <p>This test verifies that the GameManager state management and persistence features work correctly in the actual game environment.</p>
        
        <div class="test-section">
            <h2>Test Controls</h2>
            <button onclick="runStateValidationTest()">Test State Validation</button>
            <button onclick="runStateSyncTest()">Test State Synchronization</button>
            <button onclick="runDebugToolsTest()">Test Debug Tools</button>
            <button onclick="runSaveLoadTest()">Test Save/Load Integration</button>
            <button onclick="clearResults()">Clear Results</button>
        </div>

        <div class="test-section">
            <h2>Test Results</h2>
            <div id="test-results"></div>
        </div>

        <div class="test-section">
            <h2>Debug Console</h2>
            <div id="debug-console" class="debug-panel">
                Waiting for game to initialize...
            </div>
        </div>

        <div class="test-section">
            <h2>Game Instance</h2>
            <div id="game-container"></div>
        </div>
    </div>

    <script type="module">
        import('./src/main.js').then(() => {
            console.log('Game loaded successfully');
            updateDebugConsole('Game loaded successfully');
            
            // Wait for game to be ready
            setTimeout(() => {
                initializeTests();
            }, 2000);
        }).catch(error => {
            console.error('Failed to load game:', error);
            updateDebugConsole('Failed to load game: ' + error.message);
        });

        let gameManager = null;
        let testResults = [];

        function initializeTests() {
            gameManager = window.game?.plugins?.get('GameManager');
            
            if (gameManager) {
                updateDebugConsole('GameManager found and ready for testing');
                updateDebugConsole('Debug mode: ' + gameManager.gameState.debugMode);
                updateDebugConsole('Available debug tools: ' + (window.gameDebug ? 'Yes' : 'No'));
            } else {
                updateDebugConsole('ERROR: GameManager not found');
            }
        }

        function updateDebugConsole(message) {
            const console = document.getElementById('debug-console');
            const timestamp = new Date().toLocaleTimeString();
            console.textContent += `[${timestamp}] ${message}\n`;
            console.scrollTop = console.scrollHeight;
        }

        function addTestResult(testName, passed, details = '') {
            const resultsDiv = document.getElementById('test-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${passed ? 'pass' : 'fail'}`;
            resultDiv.innerHTML = `
                <strong>${testName}:</strong> ${passed ? 'PASSED' : 'FAILED'}
                ${details ? `<br><small>${details}</small>` : ''}
            `;
            resultsDiv.appendChild(resultDiv);
            
            testResults.push({ testName, passed, details });
            updateDebugConsole(`Test: ${testName} - ${passed ? 'PASSED' : 'FAILED'}`);
        }

        window.runStateValidationTest = function() {
            updateDebugConsole('Running state validation test...');
            
            if (!gameManager) {
                addTestResult('State Validation', false, 'GameManager not available');
                return;
            }

            try {
                // Test current state validation
                const currentState = gameManager.getCurrentCompleteState();
                const validation = gameManager.validateGameState(currentState);
                
                addTestResult('Current State Validation', validation.isValid, 
                    `Errors: ${validation.errors.length}, Warnings: ${validation.warnings.length}`);

                // Test invalid state validation
                const invalidState = { corrupted: true };
                const invalidValidation = gameManager.validateGameState(invalidState);
                
                addTestResult('Invalid State Detection', !invalidValidation.isValid, 
                    `Correctly detected ${invalidValidation.errors.length} errors`);

                // Test state recovery
                const recoveredState = gameManager.recoverGameState(invalidState);
                const recoveryValidation = recoveredState ? gameManager.validateGameState(recoveredState) : { isValid: false };
                
                addTestResult('State Recovery', recoveryValidation.isValid, 
                    'Successfully recovered from invalid state');

            } catch (error) {
                addTestResult('State Validation', false, `Error: ${error.message}`);
                updateDebugConsole('State validation test error: ' + error.message);
            }
        };

        window.runStateSyncTest = function() {
            updateDebugConsole('Running state synchronization test...');
            
            if (!gameManager) {
                addTestResult('State Synchronization', false, 'GameManager not available');
                return;
            }

            try {
                // Test scene state capture
                gameManager.captureSceneState('GameWorldScene');
                const sceneStates = gameManager.sceneStates;
                
                addTestResult('Scene State Capture', sceneStates.has('GameWorldScene'), 
                    `Captured ${sceneStates.size} scene states`);

                // Test state storage
                const storeResult = gameManager.storeValidState();
                
                addTestResult('Valid State Storage', storeResult, 
                    `State history length: ${gameManager.stateHistory.length}`);

                // Test complete state gathering
                const completeState = gameManager.getCurrentCompleteState();
                const hasRequiredFields = completeState.version && completeState.timestamp && 
                                        completeState.story && completeState.power && completeState.inventory;
                
                addTestResult('Complete State Gathering', hasRequiredFields, 
                    `State includes: ${Object.keys(completeState).join(', ')}`);

            } catch (error) {
                addTestResult('State Synchronization', false, `Error: ${error.message}`);
                updateDebugConsole('State sync test error: ' + error.message);
            }
        };

        window.runDebugToolsTest = function() {
            updateDebugConsole('Running debug tools test...');
            
            if (!gameManager) {
                addTestResult('Debug Tools', false, 'GameManager not available');
                return;
            }

            try {
                // Test debug mode
                const debugModeEnabled = gameManager.gameState.debugMode;
                addTestResult('Debug Mode', debugModeEnabled, 
                    `Debug mode is ${debugModeEnabled ? 'enabled' : 'disabled'}`);

                // Test debug tools availability
                const debugToolsAvailable = window.gameDebug !== undefined;
                addTestResult('Debug Tools Available', debugToolsAvailable, 
                    debugToolsAvailable ? 'window.gameDebug is accessible' : 'Debug tools not found');

                if (window.gameDebug) {
                    // Test debug functions
                    const state = window.gameDebug.getState();
                    const validation = window.gameDebug.validateState();
                    const history = window.gameDebug.getHistory();
                    
                    addTestResult('Debug Functions', 
                        state && validation && Array.isArray(history), 
                        `State: ${!!state}, Validation: ${!!validation}, History: ${history.length} entries`);
                }

                // Test debug info
                const debugInfo = gameManager.getDebugInfo();
                addTestResult('Debug Info', debugInfo && typeof debugInfo === 'object', 
                    `Debug info includes: ${Object.keys(debugInfo).join(', ')}`);

            } catch (error) {
                addTestResult('Debug Tools', false, `Error: ${error.message}`);
                updateDebugConsole('Debug tools test error: ' + error.message);
            }
        };

        window.runSaveLoadTest = function() {
            updateDebugConsole('Running save/load integration test...');
            
            if (!gameManager) {
                addTestResult('Save/Load Integration', false, 'GameManager not available');
                return;
            }

            try {
                // Test save system integration
                const saveSystem = gameManager.getSaveSystem();
                addTestResult('Save System Integration', !!saveSystem, 
                    saveSystem ? 'Save system is available' : 'Save system not found');

                if (saveSystem) {
                    // Test save data creation with validation
                    const saveData = saveSystem.createSaveData();
                    const saveDataValid = saveData && gameManager.validateGameState(saveData.gameState).isValid;
                    
                    addTestResult('Save Data Validation', saveDataValid, 
                        saveDataValid ? 'Save data passes validation' : 'Save data validation failed');

                    // Test auto-save status
                    const autoSaveEnabled = saveSystem.isAutoSaveEnabled();
                    addTestResult('Auto-Save Status', typeof autoSaveEnabled === 'boolean', 
                        `Auto-save is ${autoSaveEnabled ? 'enabled' : 'disabled'}`);
                }

                // Test available saves
                const availableSaves = gameManager.getAvailableSaves();
                addTestResult('Save File Management', Array.isArray(availableSaves), 
                    `Found ${availableSaves.length} save files`);

            } catch (error) {
                addTestResult('Save/Load Integration', false, `Error: ${error.message}`);
                updateDebugConsole('Save/load test error: ' + error.message);
            }
        };

        window.clearResults = function() {
            document.getElementById('test-results').innerHTML = '';
            document.getElementById('debug-console').textContent = 'Console cleared...\n';
            testResults = [];
            updateDebugConsole('Test results cleared');
        };

        // Auto-run basic tests when page loads
        window.addEventListener('load', () => {
            setTimeout(() => {
                if (gameManager) {
                    updateDebugConsole('Running automatic basic tests...');
                    runStateValidationTest();
                    setTimeout(() => runDebugToolsTest(), 500);
                }
            }, 3000);
        });
    </script>
</body>
</html>