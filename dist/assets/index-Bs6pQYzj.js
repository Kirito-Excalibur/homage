import{P as c}from"./phaser-0RJB29YE.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function t(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=t(i);fetch(i.href,o)}})();class h extends Phaser.Scene{constructor(){super({key:"MainMenuScene"})}preload(){this.load.image("menu-bg","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg=="),this.load.image("button-bg","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==")}create(){this.add.rectangle(400,300,800,600,2899536),this.add.text(400,150,"Top-Down Web RPG",{fontSize:"48px",fontFamily:"Arial",color:"#ecf0f1",fontStyle:"bold"}).setOrigin(.5),this.add.text(400,200,"A Story-Driven Adventure",{fontSize:"20px",fontFamily:"Arial",color:"#bdc3c7"}).setOrigin(.5);const e=this.add.rectangle(400,300,300,60,3447003);e.setStroke(2,2719929);const t=this.add.text(400,300,"Start New Adventure",{fontSize:"20px",fontFamily:"Arial",color:"#ffffff",fontStyle:"bold"}).setOrigin(.5);e.setInteractive({useHandCursor:!0}),e.on("pointerover",()=>{e.setFillStyle(2719929),t.setScale(1.05)}),e.on("pointerout",()=>{e.setFillStyle(3447003),t.setScale(1)}),e.on("pointerdown",()=>{this.startNewGame()}),this.input.keyboard.on("keydown-ENTER",()=>{this.startNewGame()}),this.add.text(400,450,"Press ENTER or click to start",{fontSize:"16px",fontFamily:"Arial",color:"#95a5a6"}).setOrigin(.5)}startNewGame(){this.scene.start("GameWorldScene")}update(){}}class d{constructor(e,t,s){this.scene=e,this.tileSize=32,this.sprite=this.scene.add.sprite(t,s,"player-sprite"),this.sprite.setOrigin(0,0),this.updateDepth(),this.speed=120,this.isMoving=!1,this.facingDirection="down",this.animationTint=16777215,this.animationTimer=0,this.animationDuration=200,this.gridX=Math.floor(t/this.tileSize),this.gridY=Math.floor(s/this.tileSize),this.inputState={up:!1,down:!1,left:!1,right:!1}}createPlaceholderSprite(){const e=this.scene.add.graphics();e.fillStyle(3447003),e.fillRect(0,0,this.tileSize,this.tileSize),e.fillStyle(16777215),e.fillCircle(this.tileSize/2,this.tileSize/2,8),e.generateTexture("player-sprite",this.tileSize,this.tileSize),e.destroy()}update(e,t){this.handleMovement(t),this.updateAnimation(e,t)}handleMovement(e){let t=0,s=0,i=this.facingDirection;this.inputState.left?(t=-this.speed,i="left"):this.inputState.right&&(t=this.speed,i="right"),this.inputState.up?(s=-this.speed,i="up"):this.inputState.down&&(s=this.speed,i="down"),t!==0&&s!==0&&(t*=.707,s*=.707),t!==0||s!==0?(this.facingDirection=i,this.isMoving=!0):this.isMoving=!1;const o=e/1e3;let r=this.sprite.x+t*o,n=this.sprite.y+s*o;const l=this.checkCollision(r,n);l.x||(this.sprite.x=r,this.gridX=Math.floor(this.sprite.x/this.tileSize)),l.y||(this.sprite.y=n,this.gridY=Math.floor(this.sprite.y/this.tileSize),this.updateDepth())}checkCollision(e,t){const s=this.scene.getWorldBounds(),i={x:!1,y:!1};(e<0||e>=s.width-this.tileSize)&&(i.x=!0),(t<0||t>=s.height-this.tileSize)&&(i.y=!0);const o=Math.floor(e/this.tileSize),r=Math.floor(t/this.tileSize);return this.scene.isCollisionTile&&this.scene.isCollisionTile(o,r)&&(Math.abs(e-this.sprite.x)>Math.abs(t-this.sprite.y)?i.x=!0:i.y=!0),i}updateAnimation(e,t){if(this.isMoving){if(this.animationTimer+=t,this.animationTimer>=this.animationDuration){this.animationTimer=0;const s=[16777215,15267064,13756914,15267064],i=Math.floor(e/this.animationDuration)%s.length;this.sprite.setTint(s[i])}}else this.sprite.setTint(16777215),this.animationTimer=0;this.updateDirectionalVisual()}updateDirectionalVisual(){switch(this.facingDirection){case"up":this.sprite.setScale(1,.95);break;case"down":this.sprite.setScale(1,1.05);break;case"left":this.sprite.setScale(.95,1);break;case"right":this.sprite.setScale(1.05,1);break;default:this.sprite.setScale(1,1)}}updateDepth(){this.sprite.setDepth(this.sprite.y+this.tileSize)}setInputState(e,t){this.inputState.hasOwnProperty(e)&&(this.inputState[e]=t)}getPosition(){return{x:this.sprite.x,y:this.sprite.y}}getGridPosition(){return{x:this.gridX,y:this.gridY}}setPosition(e,t){this.sprite.x=e,this.sprite.y=t,this.gridX=Math.floor(e/this.tileSize),this.gridY=Math.floor(t/this.tileSize)}getFacingDirection(){return this.facingDirection}isCharacterMoving(){return this.isMoving}usePower(e,t={}){const s=this.scene.plugins.get("GameManager");if(!s||!s.getPowerSystem())return console.warn("Power system not available"),!1;const i=s.getPowerSystem(),o={...t,character:this,position:this.getPosition(),gridPosition:this.getGridPosition(),facingDirection:this.facingDirection};return i.activatePower(e,o)}canUsePower(e){const t=this.scene.plugins.get("GameManager");return!t||!t.getPowerSystem()?!1:t.getPowerSystem().checkPowerAvailability(e)}getUnlockedPowers(){const e=this.scene.plugins.get("GameManager");return!e||!e.getPowerSystem()?[]:e.getPowerSystem().getUnlockedPowerList()}interact(e){console.log("Character interacting with:",e)}destroy(){this.sprite&&this.sprite.destroy()}}class u extends Phaser.Scene{constructor(){super({key:"GameWorldScene"}),this.tileSize=32,this.worldWidth=25,this.worldHeight=19,this.worldData=null}preload(){this.createPlaceholderTiles(),this.createPlaceholderCharacter()}createPlaceholderTiles(){const e=this.add.graphics();e.fillStyle(2600544),e.fillRect(0,0,this.tileSize,this.tileSize),e.generateTexture("grass-tile",this.tileSize,this.tileSize),e.destroy();const t=this.add.graphics();t.fillStyle(8359053),t.fillRect(0,0,this.tileSize,this.tileSize),t.lineStyle(1,9807270),t.strokeRect(0,0,this.tileSize,this.tileSize),t.generateTexture("stone-tile",this.tileSize,this.tileSize),t.destroy();const s=this.add.graphics();s.fillStyle(3447003),s.fillRect(0,0,this.tileSize,this.tileSize),s.generateTexture("water-tile",this.tileSize,this.tileSize),s.destroy();const i=this.add.graphics();i.fillStyle(2600544),i.fillRect(0,0,this.tileSize,this.tileSize),i.fillStyle(1999945),i.fillCircle(this.tileSize/2,this.tileSize/2,this.tileSize/3),i.generateTexture("tree-tile",this.tileSize,this.tileSize),i.destroy()}createPlaceholderCharacter(){const e=this.add.graphics();e.fillStyle(3447003),e.fillRect(0,0,this.tileSize,this.tileSize),e.fillStyle(16777215),e.fillCircle(this.tileSize/2,this.tileSize/2,8),e.generateTexture("player-sprite",this.tileSize,this.tileSize),e.destroy()}create(){this.createWorld(),this.createPlayer(),this.setupCamera(),this.setupControls(),this.createUI(),this.initializeStorySystem(),this.setupSceneEvents()}createWorld(){this.worldData=this.generateWorldData(),this.backgroundLayer=this.add.group(),this.objectLayer=this.add.group(),this.foregroundLayer=this.add.group();for(let e=0;e<this.worldHeight;e++)for(let t=0;t<this.worldWidth;t++){const s=this.worldData[e][t],i=t*this.tileSize,o=e*this.tileSize;let r,n=this.backgroundLayer;switch(s){case"grass":r=this.add.image(i,o,"grass-tile");break;case"stone":r=this.add.image(i,o,"stone-tile");break;case"water":r=this.add.image(i,o,"water-tile");break;case"tree":r=this.add.image(i,o,"tree-tile"),n=this.objectLayer;break;default:r=this.add.image(i,o,"grass-tile")}r.setOrigin(0,0),r.setDepth(o+(s==="tree"?this.tileSize:0)),n.add(r)}this.createAreaTransitions()}generateWorldData(){const e=[];for(let t=0;t<this.worldHeight;t++){e[t]=[];for(let s=0;s<this.worldWidth;s++)s===0||s===this.worldWidth-1||t===0||t===this.worldHeight-1?s===12&&t===0||s===this.worldWidth-1&&t===9||s===12&&t===this.worldHeight-1?e[t][s]="grass":e[t][s]="stone":s>=5&&s<=7&&t>=8&&t<=10||s>=15&&s<=17&&t>=4&&t<=6?e[t][s]="water":(s+t)%7===0&&Math.random()>.5||(s===11||s===13)&&(t===1||t===this.worldHeight-2)?e[t][s]="tree":e[t][s]="grass"}return e}createPlayer(){const e=Math.floor(this.worldWidth/2)*this.tileSize,t=Math.floor(this.worldHeight/2)*this.tileSize;this.player=new d(this,e,t)}setupCamera(){this.cameras.main.setBounds(0,0,this.worldWidth*this.tileSize,this.worldHeight*this.tileSize),this.cameras.main.startFollow(this.player.sprite,!0,.08,.08),this.cameras.main.setZoom(1.5),this.cameras.main.setDeadzone(100,100),this.cameras.main.useBounds=!0}setupControls(){this.cursors=this.input.keyboard.createCursorKeys(),this.wasd=this.input.keyboard.addKeys("W,S,A,D"),this.escKey=this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.ESC)}createUI(){this.uiContainer=this.add.container(0,0),this.uiContainer.setScrollFactor(0);const e=this.add.rectangle(100,30,200,20,2899536);e.setStroke(2,3426654);const t=this.add.rectangle(100,30,180,16,15158332);this.uiContainer.add([e,t]);const s=this.add.text(10,60,`Use WASD or Arrow Keys to move
Press ESC to return to menu`,{fontSize:"14px",fontFamily:"Arial",color:"#ecf0f1",backgroundColor:"rgba(0,0,0,0.5)",padding:{x:8,y:4}});this.uiContainer.add(s)}update(e,t){this.handleInput(),this.player.update(e,t),this.powerSystem&&this.powerSystem.update(e,t),this.checkAreaTransitions(),this.handleStoryTestControls(),Phaser.Input.Keyboard.JustDown(this.escKey)&&this.scene.start("MainMenuScene")}handleInput(){this.player.setInputState("left",this.cursors.left.isDown||this.wasd.A.isDown),this.player.setInputState("right",this.cursors.right.isDown||this.wasd.D.isDown),this.player.setInputState("up",this.cursors.up.isDown||this.wasd.W.isDown),this.player.setInputState("down",this.cursors.down.isDown||this.wasd.S.isDown)}getWorldBounds(){return{width:this.worldWidth*this.tileSize,height:this.worldHeight*this.tileSize}}createAreaTransitions(){this.transitionZones=this.add.group(),[{x:12*this.tileSize,y:0,width:this.tileSize,height:this.tileSize,direction:"north",targetArea:"forest_entrance"},{x:24*this.tileSize,y:9*this.tileSize,width:this.tileSize,height:this.tileSize,direction:"east",targetArea:"village_outskirts"},{x:12*this.tileSize,y:18*this.tileSize,width:this.tileSize,height:this.tileSize,direction:"south",targetArea:"cave_entrance"}].forEach(t=>{const s=this.add.zone(t.x,t.y,t.width,t.height);s.setOrigin(0,0),s.setData("direction",t.direction),s.setData("targetArea",t.targetArea);const i=this.add.rectangle(t.x+t.width/2,t.y+t.height/2,t.width,t.height,16776960,.3);i.setStroke(2,16776960),i.setDepth(1e3),this.transitionZones.add(s)})}checkAreaTransitions(){const e=this.player.getPosition(),t=Math.floor(e.x/this.tileSize),s=Math.floor(e.y/this.tileSize);this.transitionZones.children.entries.forEach(i=>{const o=Math.floor(i.x/this.tileSize),r=Math.floor(i.y/this.tileSize);t===o&&s===r&&this.triggerAreaTransition(i.getData("direction"),i.getData("targetArea"))})}triggerAreaTransition(e,t){console.log(`Area transition triggered: ${e} to ${t}`);const s=this.add.text(this.cameras.main.centerX,this.cameras.main.centerY-50,`Entering ${t.replace("_"," ")}...`,{fontSize:"24px",fontFamily:"Arial",color:"#ffffff",backgroundColor:"rgba(0,0,0,0.8)",padding:{x:20,y:10}});s.setOrigin(.5),s.setScrollFactor(0),s.setDepth(2e3),this.tweens.add({targets:s,alpha:0,duration:2e3,delay:1e3,onComplete:()=>{s.destroy()}})}initializeStorySystem(){const e=this.plugins.get("GameManager");e&&e.getStorySystem()?(this.storySystem=e.getStorySystem(),this.setupStoryEventListeners(),this.addStoryProgressUI(),this.addStoryTestControls(),console.log("Story system integrated with GameWorldScene")):console.warn("Story system not available"),this.initializePowerSystem()}initializePowerSystem(){const e=this.plugins.get("GameManager");e&&e.getPowerSystem()?(this.powerSystem=e.getPowerSystem(),this.setupPowerEventListeners(),this.addPowerUI(),console.log("Power system integrated with GameWorldScene")):console.warn("Power system not available")}setupPowerEventListeners(){this.powerSystem&&(this.powerSystem.addEventListener("power_unlocked",e=>{this.showPowerUnlockNotification(e.power,e.storyTrigger),this.updatePowerUI()}),this.powerSystem.addEventListener("power_activated",e=>{this.showPowerActivationFeedback(e.power,e.context)}),this.powerSystem.addEventListener("power_deactivated",e=>{console.log(`Power deactivated: ${e.power.name}`)}))}setupStoryEventListeners(){this.storySystem&&(this.storySystem.addEventListener("story_event_triggered",e=>{e&&e.type==="dialogue"&&this.triggerDialogue(e)}),this.storySystem.addEventListener("power_unlocked",e=>{this.showPowerUnlockNotification(e.powerId)}),this.storySystem.addEventListener("checkpoint_reached",e=>{this.showCheckpointNotification(e.checkpointId)}),this.storySystem.addEventListener("flag_changed",e=>{console.log(`Story flag changed: ${e.flag} = ${e.value}`)}))}setupSceneEvents(){this.events.on("resume",()=>{console.log("GameWorldScene resumed from dialogue"),this.updateStoryProgressUI()})}triggerDialogue(e){console.log("Triggering dialogue:",e.id),this.scene.launch("DialogueScene",{dialogueEvent:e,previousScene:"GameWorldScene"}),this.scene.pause()}addStoryProgressUI(){this.storySystem&&(this.storySystem.getStoryProgress(),this.storyProgressText=this.add.text(10,120,"",{fontSize:"12px",fontFamily:"Arial",color:"#ecf0f1",backgroundColor:"rgba(0,0,0,0.5)",padding:{x:6,y:3}}),this.storyProgressText.setScrollFactor(0),this.updateStoryProgressUI(),this.uiContainer.add(this.storyProgressText))}updateStoryProgressUI(){if(!this.storySystem||!this.storyProgressText)return;const e=this.storySystem.getStoryProgress(),t=this.storySystem.getCurrentCheckpoint();this.storyProgressText.setText([`Checkpoint: ${t?t.name:"Unknown"}`,`Events: ${e.completedEvents}/${e.totalEvents}`,`Powers: ${e.unlockedPowers}`])}addStoryTestControls(){if(!this.storySystem)return;this.testKeys={T:this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.T),D:this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.D),P:this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.P),F:this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.F),R:this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.R)};const e=this.add.text(10,180,`Story Test Controls:
T - Trigger story event
D - Test dialogue
P - Unlock power
F - Toggle flag
R - Reset story`,{fontSize:"10px",fontFamily:"Arial",color:"#f39c12",backgroundColor:"rgba(0,0,0,0.5)",padding:{x:6,y:3}});e.setScrollFactor(0),this.uiContainer.add(e)}showPowerUnlockNotification(e){const t=this.add.text(this.cameras.main.centerX,this.cameras.main.centerY,`Power Unlocked: ${e.toUpperCase()}!`,{fontSize:"28px",fontFamily:"Arial",color:"#f1c40f",backgroundColor:"rgba(0,0,0,0.8)",padding:{x:20,y:10}});t.setOrigin(.5),t.setScrollFactor(0),t.setDepth(3e3),this.tweens.add({targets:t,scaleX:1.2,scaleY:1.2,duration:300,yoyo:!0,onComplete:()=>{this.tweens.add({targets:t,alpha:0,duration:1500,delay:1e3,onComplete:()=>t.destroy()})}})}showCheckpointNotification(e){const t=this.storySystem.getCurrentCheckpoint(),s=this.add.text(this.cameras.main.centerX,this.cameras.main.centerY+50,`Checkpoint: ${t?t.name:e}`,{fontSize:"18px",fontFamily:"Arial",color:"#2ecc71",backgroundColor:"rgba(0,0,0,0.8)",padding:{x:15,y:8}});s.setOrigin(.5),s.setScrollFactor(0),s.setDepth(3e3),this.tweens.add({targets:s,alpha:0,duration:2e3,delay:1500,onComplete:()=>s.destroy()}),this.updateStoryProgressUI()}handleStoryTestControls(){if(!(!this.storySystem||!this.testKeys)){if(Phaser.Input.Keyboard.JustDown(this.testKeys.T)){const e=["first_dialogue","tutorial_start","first_power_unlock","story_branch_choice"],t=e[Math.floor(Math.random()*e.length)];this.storySystem.triggerStoryEvent(t)}if(Phaser.Input.Keyboard.JustDown(this.testKeys.D)){const e=["game_start","first_dialogue","story_branch_choice"],t=e[Math.floor(Math.random()*e.length)],s=this.storySystem.triggerStoryEvent(t);s&&s.type==="dialogue"&&this.triggerDialogue(s)}if(Phaser.Input.Keyboard.JustDown(this.testKeys.P)&&this.storySystem.unlockPower("telekinesis"),Phaser.Input.Keyboard.JustDown(this.testKeys.F)){const e=this.storySystem.getStoryFlag("tutorial_completed");this.storySystem.setStoryFlag("tutorial_completed",!e)}Phaser.Input.Keyboard.JustDown(this.testKeys.R)&&(this.storySystem.resetStory(),this.updateStoryProgressUI())}}addPowerUI(){if(!this.powerSystem)return;this.powerListText=this.add.text(10,280,"",{fontSize:"11px",fontFamily:"Arial",color:"#e67e22",backgroundColor:"rgba(0,0,0,0.5)",padding:{x:6,y:3}}),this.powerListText.setScrollFactor(0),this.updatePowerUI(),this.uiContainer.add(this.powerListText);const e=this.add.text(10,350,`Power Controls:
Q - Telekinesis
E - Enhanced Vision
R - Time Slow
F - Phase Walk`,{fontSize:"10px",fontFamily:"Arial",color:"#9b59b6",backgroundColor:"rgba(0,0,0,0.5)",padding:{x:6,y:3}});e.setScrollFactor(0),this.uiContainer.add(e)}updatePowerUI(){if(!this.powerSystem||!this.powerListText)return;const e=this.powerSystem.getUnlockedPowerList();if(e.length===0)this.powerListText.setText("No powers unlocked");else{const t=e.map(s=>{const i=this.powerSystem.getRemainingCooldown(s.id),o=this.powerSystem.isPowerActive(s.id);let r="";return o?r=" [ACTIVE]":i>0?r=` [${Math.ceil(i/1e3)}s]`:r=" [READY]",`${s.name}${r}`});this.powerListText.setText(["Unlocked Powers:",...t])}}showPowerActivationFeedback(e,t){if(!e)return;const s=this.add.text(this.cameras.main.centerX,this.cameras.main.centerY+150,`${e.name} Activated!`,{fontSize:"18px",fontFamily:"Arial",color:"#9b59b6",backgroundColor:"rgba(0,0,0,0.7)",padding:{x:10,y:5}});s.setOrigin(.5),s.setScrollFactor(0),s.setDepth(4e3),this.tweens.add({targets:s,alpha:0,y:s.y-30,duration:1500,onComplete:()=>s.destroy()}),this.updatePowerUI()}isCollisionTile(e,t){if(e<0||e>=this.worldWidth||t<0||t>=this.worldHeight)return!0;const s=this.worldData[t][e];return this.player&&this.player.isPhasing?s==="stone":s==="stone"||s==="water"||s==="tree"}}class y extends Phaser.Scene{constructor(){super({key:"DialogueScene"}),this.currentDialogue=null,this.currentText="",this.displayedText="",this.textIndex=0,this.isTyping=!1,this.typingSpeed=30,this.lastTypeTime=0,this.dialogueBox=null,this.speakerText=null,this.dialogueText=null,this.continueIndicator=null,this.choiceButtons=[],this.spaceKey=null,this.enterKey=null,this.escKey=null,this.previousScene=null,this.storySystem=null}preload(){this.createDialogueUIGraphics()}create(e){this.initializeStorySystem(),this.createDialogueUI(),this.setupControls(),this.setupSceneEvents(),e&&e.dialogueEvent&&this.startDialogue(e.dialogueEvent,e.previousScene),console.log("DialogueScene created")}createDialogueUIGraphics(){const e=this.add.graphics();e.fillStyle(2899536,.9),e.fillRoundedRect(0,0,760,150,10),e.lineStyle(3,3426654,1),e.strokeRoundedRect(0,0,760,150,10),e.generateTexture("dialogue-box",760,150),e.destroy();const t=this.add.graphics();t.fillStyle(3426654,.95),t.fillRoundedRect(0,0,200,40,8),t.lineStyle(2,6122878,1),t.strokeRoundedRect(0,0,200,40,8),t.generateTexture("speaker-box",200,40),t.destroy();const s=this.add.graphics();s.fillStyle(3447003,.8),s.fillRoundedRect(0,0,350,45,8),s.lineStyle(2,2719929,1),s.strokeRoundedRect(0,0,350,45,8),s.generateTexture("choice-button",350,45),s.destroy();const i=this.add.graphics();i.fillStyle(6139362,.9),i.fillRoundedRect(0,0,350,45,8),i.lineStyle(2,3447003,1),i.strokeRoundedRect(0,0,350,45,8),i.generateTexture("choice-button-hover",350,45),i.destroy();const o=this.add.graphics();o.fillStyle(15965202,1),o.fillTriangle(0,0,15,7,0,14),o.generateTexture("continue-arrow",15,14),o.destroy()}createDialogueUI(){this.dialogueContainer=this.add.container(0,0);const e=this.cameras.main.height-170;this.dialogueBox=this.add.image(20,e,"dialogue-box"),this.dialogueBox.setOrigin(0,0),this.dialogueBox.setVisible(!1),this.speakerBox=this.add.image(30,e-25,"speaker-box"),this.speakerBox.setOrigin(0,0),this.speakerBox.setVisible(!1),this.speakerText=this.add.text(130,e-5,"",{fontSize:"18px",fontFamily:"Arial",color:"#ecf0f1",fontStyle:"bold"}),this.speakerText.setOrigin(.5,.5),this.speakerText.setVisible(!1),this.dialogueText=this.add.text(50,e+30,"",{fontSize:"16px",fontFamily:"Arial",color:"#ecf0f1",wordWrap:{width:700,useAdvancedWrap:!0},lineSpacing:5}),this.dialogueText.setOrigin(0,0),this.dialogueText.setVisible(!1),this.continueIndicator=this.add.image(750,e+120,"continue-arrow"),this.continueIndicator.setOrigin(.5,.5),this.continueIndicator.setVisible(!1),this.tweens.add({targets:this.continueIndicator,alpha:.3,duration:800,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),this.dialogueContainer.add([this.dialogueBox,this.speakerBox,this.speakerText,this.dialogueText,this.continueIndicator]),this.choicesContainer=this.add.container(0,0),this.choicesContainer.setVisible(!1)}setupControls(){this.spaceKey=this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE),this.enterKey=this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.ENTER),this.escKey=this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.ESC),this.input.on("pointerdown",this.handleDialogueAdvance,this)}setupSceneEvents(){this.events.on("wake",this.handleSceneWake,this),this.events.on("sleep",this.handleSceneSleep,this)}initializeStorySystem(){const e=this.plugins.get("GameManager");e&&e.getStorySystem()?(this.storySystem=e.getStorySystem(),console.log("DialogueScene connected to StorySystem")):console.warn("StorySystem not available in DialogueScene")}startDialogue(e,t="GameWorldScene"){this.currentDialogue=e,this.previousScene=t,this.showDialogueUI(),this.startTypingText(e.content.text,e.content.speaker),console.log("Started dialogue:",e.id)}showDialogueUI(){this.dialogueBox.setVisible(!0),this.speakerBox.setVisible(!0),this.speakerText.setVisible(!0),this.dialogueText.setVisible(!0),this.continueIndicator.setVisible(!1),this.hideChoices()}hideDialogueUI(){this.dialogueBox.setVisible(!1),this.speakerBox.setVisible(!1),this.speakerText.setVisible(!1),this.dialogueText.setVisible(!1),this.continueIndicator.setVisible(!1),this.hideChoices()}startTypingText(e,t){this.currentText=e,this.displayedText="",this.textIndex=0,this.isTyping=!0,this.lastTypeTime=0,this.speakerText.setText(t||"Unknown"),this.dialogueText.setText(""),this.continueIndicator.setVisible(!1)}update(e,t){this.isTyping&&this.updateTextTyping(e),this.handleInput()}updateTextTyping(e){e-this.lastTypeTime>1e3/this.typingSpeed&&(this.textIndex<this.currentText.length?(this.displayedText+=this.currentText[this.textIndex],this.textIndex++,this.lastTypeTime=e,this.dialogueText.setText(this.displayedText)):(this.isTyping=!1,this.onTypingComplete()))}onTypingComplete(){this.currentDialogue&&this.currentDialogue.content.choices?this.showChoices(this.currentDialogue.content.choices):this.continueIndicator.setVisible(!0)}handleInput(){(Phaser.Input.Keyboard.JustDown(this.spaceKey)||Phaser.Input.Keyboard.JustDown(this.enterKey))&&this.handleDialogueAdvance(),Phaser.Input.Keyboard.JustDown(this.escKey)&&this.closeDialogue()}handleDialogueAdvance(){this.isTyping?this.skipTyping():this.currentDialogue&&this.advanceDialogue()}skipTyping(){this.isTyping=!1,this.displayedText=this.currentText,this.textIndex=this.currentText.length,this.dialogueText.setText(this.displayedText),this.onTypingComplete()}advanceDialogue(){if(!(this.currentDialogue.content.choices&&this.choicesContainer.visible)){if(this.currentDialogue.content.nextEvent&&this.storySystem){const e=this.storySystem.triggerStoryEvent(this.currentDialogue.content.nextEvent);if(e){this.startDialogue(e,this.previousScene);return}}this.closeDialogue()}}showChoices(e){this.hideChoices();const t=this.cameras.main.height-300,s=60;e.forEach((i,o)=>{const r=t+o*s,n=this.add.image(400,r,"choice-button");n.setOrigin(.5,.5),n.setInteractive();const l=this.add.text(400,r,i.text,{fontSize:"14px",fontFamily:"Arial",color:"#ecf0f1",wordWrap:{width:320,useAdvancedWrap:!0},align:"center"});l.setOrigin(.5,.5),n.on("pointerover",()=>{n.setTexture("choice-button-hover"),l.setColor("#ffffff")}),n.on("pointerout",()=>{n.setTexture("choice-button"),l.setColor("#ecf0f1")}),n.on("pointerdown",()=>{this.selectChoice(i,o)}),this.choiceButtons.push({button:n,text:l}),this.choicesContainer.add([n,l])}),this.choicesContainer.setVisible(!0)}hideChoices(){this.choiceButtons.forEach(({button:e,text:t})=>{e.destroy(),t.destroy()}),this.choiceButtons=[],this.choicesContainer.removeAll(),this.choicesContainer.setVisible(!1)}selectChoice(e,t){if(console.log(`Choice selected: ${t} - ${e.text}`),e.effects&&this.storySystem&&e.effects.forEach(s=>{switch(s.type){case"set_flag":this.storySystem.setStoryFlag(s.flag,s.value);break;case"unlock_power":this.storySystem.unlockPower(s.powerId);break;case"set_checkpoint":this.storySystem.setCheckpoint(s.checkpointId);break}}),this.hideChoices(),e.nextEvent&&this.storySystem){const s=this.storySystem.triggerStoryEvent(e.nextEvent);if(s){this.startDialogue(s,this.previousScene);return}}this.closeDialogue()}closeDialogue(){this.hideDialogueUI(),this.currentDialogue=null,this.currentText="",this.displayedText="",this.textIndex=0,this.isTyping=!1,this.previousScene&&(this.scene.resume(this.previousScene),this.scene.stop()),console.log("Dialogue closed, returning to:",this.previousScene)}handleSceneWake(e,t){t&&t.dialogueEvent&&this.startDialogue(t.dialogueEvent,t.previousScene)}handleSceneSleep(){this.hideDialogueUI()}static showDialogue(e,t,s="GameWorldScene"){e.scene.launch("DialogueScene",{dialogueEvent:t,previousScene:s}),e.scene.pause()}}class g extends Phaser.Scene{constructor(){super({key:"InventoryScene"})}}class p{constructor(e){this.scene=e,this.storyData=null,this.currentCheckpoint="game_start",this.completedEvents=new Set,this.storyFlags=new Map,this.unlockedPowers=new Set,this.eventListeners=new Map,this.initializeStoryState()}initializeStoryState(){this.storyFlags.set("game_started",!1),this.storyFlags.set("first_dialogue_seen",!1),this.storyFlags.set("tutorial_completed",!1)}async loadStoryData(e){try{const t=await fetch(e);if(!t.ok)throw new Error(`Failed to load story data: ${t.status}`);if(this.storyData=await t.json(),!this.validateStoryData(this.storyData))throw new Error("Invalid story data structure");return console.log("Story data loaded successfully"),!0}catch(t){return console.error("Error loading story data:",t),this.loadFallbackStoryData(),!1}}validateStoryData(e){return e&&e.events&&Array.isArray(e.events)&&e.checkpoints&&typeof e.checkpoints=="object"}loadFallbackStoryData(){this.storyData={events:[{id:"game_start",type:"dialogue",triggers:[],content:{text:"Welcome to your adventure!",speaker:"Narrator",nextEvent:null}}],checkpoints:{game_start:{id:"game_start",name:"Beginning",description:"The start of your journey"}}},console.log("Fallback story data loaded")}triggerStoryEvent(e){if(!this.storyData||!this.storyData.events)return console.warn("No story data available"),null;const t=this.storyData.events.find(s=>s.id===e);return t?this.checkStoryConditions(t.triggers||[])?(this.completedEvents.add(e),this.processEventEffects(t),this.emitStoryEvent(e,t),this.emitStoryEvent("story_event_triggered",t),console.log(`Story event triggered: ${e}`),t):(console.log(`Story event conditions not met: ${e}`),null):(console.warn(`Story event not found: ${e}`),null)}checkStoryConditions(e){return!e||e.length===0?!0:e.every(t=>{switch(t.type){case"flag":return this.storyFlags.get(t.flag)===t.value;case"event_completed":return this.completedEvents.has(t.eventId);case"power_unlocked":return this.unlockedPowers.has(t.powerId);case"checkpoint_reached":return this.hasReachedCheckpoint(t.checkpointId);default:return console.warn(`Unknown condition type: ${t.type}`),!1}})}processEventEffects(e){e.effects&&e.effects.forEach(t=>{switch(t.type){case"unlock_power":this.unlockPower(t.powerId);break;case"set_flag":this.setStoryFlag(t.flag,t.value);break;case"set_checkpoint":this.setCheckpoint(t.checkpointId);break;default:console.warn(`Unknown effect type: ${t.type}`)}})}setCheckpoint(e){if(!this.storyData||!this.storyData.checkpoints||!this.storyData.checkpoints[e]){console.warn(`Invalid checkpoint: ${e}`);return}this.currentCheckpoint=e,console.log(`Checkpoint set: ${e}`),this.emitStoryEvent("checkpoint_reached",{checkpointId:e})}hasReachedCheckpoint(e){return!this.storyData||!this.storyData.checkpoints?!1:this.currentCheckpoint===e||this.completedEvents.has(`checkpoint_${e}`)}getCurrentCheckpoint(){return!this.storyData||!this.storyData.checkpoints?null:this.storyData.checkpoints[this.currentCheckpoint]||null}setStoryFlag(e,t){const s=this.storyFlags.get(e);this.storyFlags.set(e,t),console.log(`Story flag set: ${e} = ${t} (was: ${s})`),this.emitStoryEvent("flag_changed",{flag:e,value:t,oldValue:s})}getStoryFlag(e){return this.storyFlags.get(e)}checkStoryFlag(e,t){return this.storyFlags.get(e)===t}unlockPower(e){if(this.unlockedPowers.has(e)){console.log(`Power already unlocked: ${e}`);return}this.unlockedPowers.add(e),console.log(`Power unlocked: ${e}`),this.emitStoryEvent("power_unlocked",{powerId:e})}isPowerUnlocked(e){return this.unlockedPowers.has(e)}getUnlockedPowers(){return Array.from(this.unlockedPowers)}addEventListener(e,t){this.eventListeners.has(e)||this.eventListeners.set(e,[]),this.eventListeners.get(e).push(t)}removeEventListener(e,t){if(!this.eventListeners.has(e))return;const s=this.eventListeners.get(e),i=s.indexOf(t);i>-1&&s.splice(i,1)}emitStoryEvent(e,t){this.eventListeners.has(e)&&this.eventListeners.get(e).forEach(s=>{try{s(t)}catch(i){console.error(`Error in story event listener for ${e}:`,i)}})}getStoryState(){return{currentCheckpoint:this.currentCheckpoint,completedEvents:Array.from(this.completedEvents),storyFlags:Object.fromEntries(this.storyFlags),unlockedPowers:Array.from(this.unlockedPowers)}}loadStoryState(e){e&&(this.currentCheckpoint=e.currentCheckpoint||"game_start",this.completedEvents=new Set(e.completedEvents||[]),this.storyFlags=new Map(Object.entries(e.storyFlags||{})),this.unlockedPowers=new Set(e.unlockedPowers||[]),console.log("Story state loaded"))}resetStory(){this.currentCheckpoint="game_start",this.completedEvents.clear(),this.storyFlags.clear(),this.unlockedPowers.clear(),this.initializeStoryState(),console.log("Story reset to initial state")}getStoryProgress(){const e=this.storyData?this.storyData.events.length:0,t=this.completedEvents.size;return{currentCheckpoint:this.currentCheckpoint,completedEvents:t,totalEvents:e,progressPercentage:e>0?t/e*100:0,unlockedPowers:this.getUnlockedPowers().length}}}class f{constructor(e){this.scene=e,this.powers=new Map,this.unlockedPowers=new Set,this.activePowers=new Map,this.cooldowns=new Map,this.eventListeners=new Map,this.initializePowerDefinitions(),this.setupPowerControls(),console.log("PowerSystem initialized")}initializePowerDefinitions(){[{id:"telekinesis",name:"Telekinesis",description:"Move objects with your mind",type:"active",cooldown:3e3,range:64,effects:[{type:"move_object",strength:1},{type:"visual_effect",effect:"telekinesis_glow"}],unlockCondition:"first_power_unlock",activationKey:"Q"},{id:"enhanced_vision",name:"Enhanced Vision",description:"See hidden objects and secrets",type:"toggle",cooldown:0,range:0,effects:[{type:"reveal_hidden",duration:-1},{type:"visual_effect",effect:"vision_overlay"}],unlockCondition:"vision_power_unlock",activationKey:"E"},{id:"time_slow",name:"Time Slow",description:"Slow down time around you",type:"active",cooldown:1e4,range:0,effects:[{type:"time_manipulation",factor:.5,duration:3e3},{type:"visual_effect",effect:"time_distortion"}],unlockCondition:"time_power_unlock",activationKey:"R"},{id:"phase_walk",name:"Phase Walk",description:"Walk through certain obstacles",type:"active",cooldown:8e3,range:0,effects:[{type:"phase_through",duration:2e3},{type:"visual_effect",effect:"phase_glow"}],unlockCondition:"phase_power_unlock",activationKey:"F"}].forEach(t=>{this.powers.set(t.id,t)})}setupPowerControls(){!this.scene||!this.scene.input||(this.powerKeys={},this.powers.forEach(e=>{if(e.activationKey){const t=Phaser.Input.Keyboard.KeyCodes[e.activationKey];t&&(this.powerKeys[e.id]=this.scene.input.keyboard.addKey(t))}}),console.log("Power controls set up"))}unlockPower(e,t=null){if(!this.powers.has(e))return console.warn(`Power not found: ${e}`),!1;if(this.unlockedPowers.has(e))return console.log(`Power already unlocked: ${e}`),!1;const s=this.powers.get(e);return this.unlockedPowers.add(e),this.showPowerUnlockNotification(s,t),this.emitPowerEvent("power_unlocked",{powerId:e,power:s,storyTrigger:t}),console.log(`Power unlocked: ${e} (triggered by: ${t||"unknown"})`),!0}checkPowerAvailability(e){if(!this.unlockedPowers.has(e))return!1;if(this.cooldowns.has(e)){const t=this.cooldowns.get(e);if(Date.now()<t)return!1;this.cooldowns.delete(e)}return!0}activatePower(e,t={}){if(!this.checkPowerAvailability(e))return console.log(`Power not available: ${e}`),!1;const s=this.powers.get(e);if(!s)return console.warn(`Power not found: ${e}`),!1;switch(s.cooldown>0&&this.cooldowns.set(e,Date.now()+s.cooldown),s.type){case"active":this.activateActivePower(s,t);break;case"toggle":this.togglePower(s,t);break;case"passive":console.log(`Passive power ${e} is always active`);break;default:return console.warn(`Unknown power type: ${s.type}`),!1}return this.showPowerActivationFeedback(s,t),this.emitPowerEvent("power_activated",{powerId:e,power:s,context:t}),console.log(`Power activated: ${e}`),!0}activateActivePower(e,t){var i;e.effects.forEach(o=>{this.applyPowerEffect(o,e,t)});const s=((i=e.effects.find(o=>o.duration))==null?void 0:i.duration)||1e3;s>0&&(this.activePowers.set(e.id,{power:e,context:t,startTime:Date.now(),duration:s}),setTimeout(()=>{this.deactivatePower(e.id)},s))}togglePower(e,t){this.activePowers.has(e.id)?this.deactivatePower(e.id):(e.effects.forEach(s=>{this.applyPowerEffect(s,e,t)}),this.activePowers.set(e.id,{power:e,context:t,startTime:Date.now(),duration:-1}))}deactivatePower(e){if(!this.activePowers.has(e))return;const t=this.activePowers.get(e),s=t.power;s.effects.forEach(i=>{this.removePowerEffect(i,s,t.context)}),this.activePowers.delete(e),this.emitPowerEvent("power_deactivated",{powerId:e,power:s}),console.log(`Power deactivated: ${e}`)}applyPowerEffect(e,t,s){switch(e.type){case"move_object":this.applyTelekinesisEffect(e,t,s);break;case"reveal_hidden":this.applyVisionEffect(e,t,s);break;case"time_manipulation":this.applyTimeEffect(e,t,s);break;case"phase_through":this.applyPhaseEffect(e,t,s);break;case"visual_effect":this.applyVisualEffect(e,t,s);break;default:console.warn(`Unknown effect type: ${e.type}`)}}removePowerEffect(e,t,s){switch(e.type){case"reveal_hidden":this.removeVisionEffect(e,t,s);break;case"time_manipulation":this.removeTimeEffect(e,t,s);break;case"phase_through":this.removePhaseEffect(e,t,s);break;case"visual_effect":this.removeVisualEffect(e,t,s);break}}applyTelekinesisEffect(e,t,s){if(!this.scene.player)return;const i=this.scene.player.getPosition(),o=t.range||64,r=this.scene.add.circle(i.x+16,i.y+16,o,10181046,.3);r.setStroke(2,9323693),r.setDepth(1e3),this.scene.tweens.add({targets:r,scaleX:1.2,scaleY:1.2,alpha:0,duration:1e3,onComplete:()=>r.destroy()}),console.log("Telekinesis effect applied")}applyVisionEffect(e,t,s){this.visionOverlay=this.scene.add.rectangle(this.scene.cameras.main.centerX,this.scene.cameras.main.centerY,this.scene.cameras.main.width,this.scene.cameras.main.height,65535,.1),this.visionOverlay.setScrollFactor(0),this.visionOverlay.setDepth(500),console.log("Enhanced vision effect applied")}removeVisionEffect(e,t,s){this.visionOverlay&&(this.visionOverlay.destroy(),this.visionOverlay=null),console.log("Enhanced vision effect removed")}applyTimeEffect(e,t,s){this.scene.physics&&this.scene.physics.world&&(this.originalTimeScale=this.scene.physics.world.timeScale,this.scene.physics.world.timeScale=e.factor||.5),this.timeDistortionEffect=this.scene.add.rectangle(this.scene.cameras.main.centerX,this.scene.cameras.main.centerY,this.scene.cameras.main.width,this.scene.cameras.main.height,16777215,.05),this.timeDistortionEffect.setScrollFactor(0),this.timeDistortionEffect.setDepth(600),console.log("Time manipulation effect applied")}removeTimeEffect(e,t,s){this.scene.physics&&this.scene.physics.world&&this.originalTimeScale!==void 0&&(this.scene.physics.world.timeScale=this.originalTimeScale),this.timeDistortionEffect&&(this.timeDistortionEffect.destroy(),this.timeDistortionEffect=null),console.log("Time manipulation effect removed")}applyPhaseEffect(e,t,s){this.scene.player&&this.scene.player.sprite&&(this.scene.player.sprite.setAlpha(.5),this.scene.player.sprite.setTint(65535),this.scene.player.isPhasing=!0),console.log("Phase walk effect applied")}removePhaseEffect(e,t,s){this.scene.player&&this.scene.player.sprite&&(this.scene.player.sprite.setAlpha(1),this.scene.player.sprite.clearTint(),this.scene.player.isPhasing=!1),console.log("Phase walk effect removed")}applyVisualEffect(e,t,s){switch(e.effect){case"telekinesis_glow":this.createGlowEffect(10181046);break;case"vision_overlay":break;case"time_distortion":break;case"phase_glow":this.createGlowEffect(65535);break}}removeVisualEffect(e,t,s){}createGlowEffect(e){if(!this.scene.player)return;const t=this.scene.player.getPosition(),s=this.scene.add.circle(t.x+16,t.y+16,20,e,.4);s.setDepth(this.scene.player.sprite.depth-1),this.scene.tweens.add({targets:s,scaleX:1.5,scaleY:1.5,alpha:0,duration:800,onComplete:()=>s.destroy()})}update(e,t){this.handlePowerInput(),this.updateActivePowers(e,t),this.updateCooldownDisplays()}handlePowerInput(){this.powerKeys&&this.powers.forEach((e,t)=>{const s=this.powerKeys[t];s&&Phaser.Input.Keyboard.JustDown(s)&&this.activatePower(t)})}updateActivePowers(e,t){this.activePowers.forEach((s,i)=>{s.duration>0&&e-s.startTime>=s.duration&&this.deactivatePower(i)})}updateCooldownDisplays(){}showPowerUnlockNotification(e,t){if(!this.scene)return;const s=this.scene.add.container(this.scene.cameras.main.centerX,this.scene.cameras.main.centerY-100);s.setScrollFactor(0),s.setDepth(5e3);const i=this.scene.add.rectangle(0,0,400,120,2899536,.9);i.setStroke(3,15965202);const o=this.scene.add.text(0,-30,"NEW POWER UNLOCKED!",{fontSize:"20px",fontFamily:"Arial",color:"#f39c12",fontStyle:"bold"});o.setOrigin(.5);const r=this.scene.add.text(0,0,e.name,{fontSize:"24px",fontFamily:"Arial",color:"#ecf0f1",fontStyle:"bold"});r.setOrigin(.5);const n=this.scene.add.text(0,25,e.description,{fontSize:"14px",fontFamily:"Arial",color:"#bdc3c7"});n.setOrigin(.5);const l=this.scene.add.text(0,45,`Press ${e.activationKey} to use`,{fontSize:"12px",fontFamily:"Arial",color:"#95a5a6"});l.setOrigin(.5),s.add([i,o,r,n,l]),s.setScale(0),this.scene.tweens.add({targets:s,scaleX:1,scaleY:1,duration:500,ease:"Back.easeOut",onComplete:()=>{this.scene.tweens.add({targets:s,alpha:0,duration:1e3,delay:3e3,onComplete:()=>s.destroy()})}})}showPowerActivationFeedback(e,t){if(!this.scene)return;const s=this.scene.add.text(this.scene.cameras.main.centerX,this.scene.cameras.main.centerY+150,e.name,{fontSize:"18px",fontFamily:"Arial",color:"#f39c12",backgroundColor:"rgba(0,0,0,0.7)",padding:{x:10,y:5}});s.setOrigin(.5),s.setScrollFactor(0),s.setDepth(4e3),this.scene.tweens.add({targets:s,alpha:0,y:s.y-30,duration:1500,onComplete:()=>s.destroy()})}getPowerList(){return Array.from(this.powers.values())}getUnlockedPowerList(){return Array.from(this.unlockedPowers).map(e=>this.powers.get(e))}getPower(e){return this.powers.get(e)||null}isPowerActive(e){return this.activePowers.has(e)}getRemainingCooldown(e){if(!this.cooldowns.has(e))return 0;const s=this.cooldowns.get(e)-Date.now();return Math.max(0,s)}addEventListener(e,t){this.eventListeners.has(e)||this.eventListeners.set(e,[]),this.eventListeners.get(e).push(t)}removeEventListener(e,t){if(!this.eventListeners.has(e))return;const s=this.eventListeners.get(e),i=s.indexOf(t);i>-1&&s.splice(i,1)}emitPowerEvent(e,t){this.eventListeners.has(e)&&this.eventListeners.get(e).forEach(s=>{try{s(t)}catch(i){console.error(`Error in power event listener for ${e}:`,i)}})}getPowerSystemState(){return{unlockedPowers:Array.from(this.unlockedPowers),activePowers:Array.from(this.activePowers.keys()),cooldowns:Object.fromEntries(this.cooldowns)}}loadPowerSystemState(e){e&&(this.unlockedPowers=new Set(e.unlockedPowers||[]),this.cooldowns=new Map(Object.entries(e.cooldowns||{})),this.activePowers.clear(),console.log("Power system state loaded"))}resetPowerSystem(){this.unlockedPowers.clear(),this.activePowers.clear(),this.cooldowns.clear(),console.log("Power system reset to initial state")}destroy(){this.activePowers.forEach((e,t)=>{this.deactivatePower(t)}),this.powers.clear(),this.unlockedPowers.clear(),this.activePowers.clear(),this.cooldowns.clear(),this.eventListeners.clear(),this.powerKeys=null,console.log("PowerSystem destroyed")}}class w extends Phaser.Plugins.BasePlugin{constructor(e){super(e),this.storySystem=null,this.powerSystem=null,this.gameState={initialized:!1,currentScene:null}}init(){console.log("GameManager initialized")}start(){console.log("GameManager started"),this.initializeSystems()}initializeSystems(){const e=this.game.scene.getScene("GameWorldScene");this.storySystem=new p(e),this.powerSystem=new f(e),this.setupSystemIntegration(),this.loadStoryData(),this.gameState.initialized=!0,console.log("Game systems initialized")}setupSystemIntegration(){!this.storySystem||!this.powerSystem||(this.storySystem.addEventListener("power_unlocked",e=>{this.powerSystem.unlockPower(e.powerId,"story_progression")}),this.powerSystem.addEventListener("power_activated",e=>{this.checkPowerStoryTriggers(e.powerId,e.context)}),console.log("System integration set up"))}checkPowerStoryTriggers(e,t){const i={telekinesis:"first_telekinesis_use",enhanced_vision:"first_vision_use",time_slow:"first_time_manipulation",phase_walk:"first_phase_walk"}[e];i&&this.storySystem.triggerStoryEvent(i)}async loadStoryData(){try{await this.storySystem.loadStoryData("./src/assets/story/main-story.json")?(console.log("Story data loaded successfully"),this.storySystem.triggerStoryEvent("game_start")):console.warn("Failed to load story data, using fallback")}catch(e){console.error("Error loading story data:",e)}}getStorySystem(){return this.storySystem}getPowerSystem(){return this.powerSystem}saveGame(){if(!this.storySystem||!this.powerSystem)return console.warn("Cannot save game: Systems not initialized"),null;const e={timestamp:Date.now(),story:this.storySystem.getStoryState(),powers:this.powerSystem.getPowerSystemState(),gameVersion:"1.0.0"};try{return localStorage.setItem("rpg_save_data",JSON.stringify(e)),console.log("Game saved successfully"),e}catch(t){return console.error("Error saving game:",t),null}}loadGame(){try{const e=localStorage.getItem("rpg_save_data");if(!e)return console.log("No save data found"),!1;const t=JSON.parse(e);return!this.storySystem||!this.powerSystem?(console.warn("Cannot load game: Systems not initialized"),!1):(this.storySystem.loadStoryState(t.story),t.powers&&this.powerSystem.loadPowerSystemState(t.powers),console.log("Game loaded successfully"),!0)}catch(e){return console.error("Error loading game:",e),!1}}getGameState(){return{...this.gameState,story:this.storySystem?this.storySystem.getStoryProgress():null}}resetGame(){this.storySystem&&this.storySystem.resetStory(),this.powerSystem&&this.powerSystem.resetPowerSystem(),localStorage.removeItem("rpg_save_data"),console.log("Game reset to initial state")}}const m={type:c.AUTO,width:800,height:600,parent:"game-container",backgroundColor:"#2c3e50",physics:{default:"arcade",arcade:{gravity:{y:0},debug:!1}},scene:[h,u,y,g],plugins:{global:[{key:"GameManager",plugin:w,start:!0}]},scale:{mode:c.Scale.FIT,autoCenter:c.Scale.CENTER_BOTH}},S=new c.Game(m);window.game=S;function v(){console.log("=== Testing PowerSystem ===");const a=window.game;if(!a){console.error("Game instance not found");return}const e=a.plugins.get("GameManager");if(!e){console.error("GameManager not found");return}const t=e.getPowerSystem();if(!t){console.error("PowerSystem not found");return}console.log("PowerSystem found:",t),console.log(`
--- Test 1: Initial State ---`),console.log("Available powers:",t.getPowerList().map(r=>r.id)),console.log("Unlocked powers:",t.getUnlockedPowerList().map(r=>r.id)),console.log(`
--- Test 2: Unlock Telekinesis ---`);const s=t.unlockPower("telekinesis","test_trigger");console.log("Unlock result:",s),console.log("Unlocked powers after unlock:",t.getUnlockedPowerList().map(r=>r.id)),console.log(`
--- Test 3: Check Power Availability ---`),console.log("Can use telekinesis:",t.checkPowerAvailability("telekinesis")),console.log("Can use enhanced_vision:",t.checkPowerAvailability("enhanced_vision")),console.log(`
--- Test 4: Activate Telekinesis ---`);const i=t.activatePower("telekinesis",{test:!0});console.log("Activation result:",i),console.log("Is telekinesis active:",t.isPowerActive("telekinesis")),console.log("Remaining cooldown:",t.getRemainingCooldown("telekinesis")),setTimeout(()=>{console.log(`
--- Test 5: Try Activation During Cooldown ---`);const r=t.activatePower("telekinesis",{test:!0});console.log("Activation during cooldown result:",r),console.log("Remaining cooldown:",t.getRemainingCooldown("telekinesis"))},1e3),console.log(`
--- Test 6: Story Integration ---`);const o=e.getStorySystem();o&&(console.log("Story system found, testing power unlock through story"),o.unlockPower("enhanced_vision"),console.log("Powers after story unlock:",t.getUnlockedPowerList().map(r=>r.id))),console.log(`
=== PowerSystem Test Complete ===`)}function k(){console.log("=== Testing Story-Power Integration ===");const a=window.game,e=a==null?void 0:a.plugins.get("GameManager"),t=e==null?void 0:e.getStorySystem(),s=e==null?void 0:e.getPowerSystem();if(!t||!s){console.error("Required systems not found");return}console.log("Triggering first_power_unlock story event...");const i=t.triggerStoryEvent("first_power_unlock");console.log("Story event result:",i),setTimeout(()=>{console.log("Powers after story event:",s.getUnlockedPowerList().map(o=>o.id))},500),console.log("=== Story-Power Integration Test Complete ===")}window.testPowerSystem=v;window.testStoryPowerIntegration=k;console.log("Power system test functions loaded. Use testPowerSystem() or testStoryPowerIntegration() in console.");
//# sourceMappingURL=index-Bs6pQYzj.js.map
